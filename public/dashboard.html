<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lookfor MAS Dashboard - logicsticks</title>
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #12121a;
      --surface-2: #1a1a24;
      --border: #2a2a3a;
      --text: #e0e0e0;
      --text-dim: #808090;
      --accent: #6366f1;
      --accent-dim: #4f46e5;
      --success: #22c55e;
      --error: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 1rem;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: var(--surface);
      border-radius: 8px;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
    }
    .logo { font-size: 1.5rem; font-weight: bold; color: var(--accent); }
    .status { display: flex; gap: 1rem; align-items: center; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--success); animation: pulse 2s infinite; }
    .status-dot.error { background: var(--error); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .grid { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 1rem; height: calc(100vh - 140px); }

    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .panel-header {
      padding: 0.75rem 1rem;
      background: var(--surface-2);
      border-bottom: 1px solid var(--border);
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .panel-content { flex: 1; overflow-y: auto; padding: 1rem; }

    .session-item {
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      background: var(--surface-2);
      border: 1px solid transparent;
      transition: all 0.2s;
    }
    .session-item:hover { border-color: var(--accent); }
    .session-item.active { border-color: var(--accent); background: rgba(99, 102, 241, 0.1); }
    .session-customer { font-weight: bold; }
    .session-meta { font-size: 0.8rem; color: var(--text-dim); margin-top: 0.25rem; }
    .session-status { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; }
    .session-status.active { background: var(--success); color: #000; }
    .session-status.escalated { background: var(--error); color: #fff; }

    .chat-container { display: flex; flex-direction: column; height: 100%; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 1rem; }
    .message { margin-bottom: 1rem; max-width: 80%; }
    .message.customer { margin-left: auto; }
    .message-bubble {
      padding: 0.75rem 1rem;
      border-radius: 12px;
      background: var(--surface-2);
    }
    .message.customer .message-bubble { background: var(--accent-dim); }
    .message-meta { font-size: 0.7rem; color: var(--text-dim); margin-top: 0.25rem; text-align: right; }
    .message.customer .message-meta { text-align: left; }

    .chat-input {
      display: flex;
      gap: 0.5rem;
      padding: 1rem;
      background: var(--surface-2);
      border-top: 1px solid var(--border);
    }
    .chat-input input {
      flex: 1;
      padding: 0.75rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: inherit;
    }
    .chat-input button {
      padding: 0.75rem 1.5rem;
      background: var(--accent);
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-family: inherit;
    }
    .chat-input button:hover { background: var(--accent-dim); }

    .trace-event {
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border-left: 3px solid var(--border);
      padding-left: 1rem;
      font-size: 0.85rem;
    }
    .trace-event.routing { border-color: var(--info); }
    .trace-event.tool_call { border-color: var(--warning); }
    .trace-event.tool_call.success { border-color: var(--success); }
    .trace-event.tool_call.failure { border-color: var(--error); }
    .trace-event.escalation { border-color: var(--error); background: rgba(239, 68, 68, 0.1); }
    .trace-event.message { border-color: var(--text-dim); }
    .trace-type { font-weight: bold; text-transform: uppercase; font-size: 0.7rem; }
    .trace-time { color: var(--text-dim); font-size: 0.7rem; }
    .trace-data { margin-top: 0.25rem; color: var(--text-dim); }
    .trace-data code { background: var(--bg); padding: 2px 4px; border-radius: 3px; }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal-overlay.hidden { display: none; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 2rem;
      width: 400px;
    }
    .modal h2 { margin-bottom: 1rem; }
    .modal input {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: inherit;
    }
    .modal-buttons { display: flex; gap: 1rem; justify-content: flex-end; }
    .modal-buttons button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
    }
    .modal-buttons .cancel { background: var(--surface-2); color: var(--text); }
    .modal-buttons .submit { background: var(--accent); color: white; }

    .loading { color: var(--text-dim); text-align: center; padding: 2rem; }

    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
    .stat { background: var(--surface-2); padding: 0.5rem; border-radius: 6px; text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: bold; }
    .stat-label { font-size: 0.7rem; color: var(--text-dim); }
    .stat.success .stat-value { color: var(--success); }
    .stat.error .stat-value { color: var(--error); }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">Lookfor MAS Dashboard</div>
    <div class="status">
      <span>logicsticks</span>
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Connected</span>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <div class="panel-header">
        <span>Sessions</span>
        <button onclick="showNewSessionModal()" style="background: var(--accent); border: none; padding: 0.25rem 0.75rem; border-radius: 4px; color: white; cursor: pointer;">+ New</button>
      </div>
      <div class="panel-content" id="sessionsList">
        <div class="loading">Loading sessions...</div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <span id="chatTitle">Select a session</span>
        <span id="chatAgent" style="color: var(--text-dim); font-size: 0.8rem;"></span>
      </div>
      <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
          <div class="loading">Select a session to view conversation</div>
        </div>
        <div class="chat-input">
          <input type="text" id="messageInput" placeholder="Type customer message..." onkeypress="if(event.key==='Enter')sendMessage()">
          <button onclick="sendMessage()">Send</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <span>Trace Timeline</span>
      </div>
      <div class="panel-content">
        <div class="stats" id="traceStats"></div>
        <div id="traceTimeline">
          <div class="loading">Select a session to view trace</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay hidden" id="newSessionModal">
    <div class="modal">
      <h2>Start New Session</h2>
      <input type="email" id="customerEmail" placeholder="Customer Email">
      <input type="text" id="firstName" placeholder="First Name">
      <input type="text" id="lastName" placeholder="Last Name">
      <input type="text" id="shopifyId" placeholder="Shopify Customer ID">
      <div class="modal-buttons">
        <button class="cancel" onclick="hideNewSessionModal()">Cancel</button>
        <button class="submit" onclick="createSession()">Start Session</button>
      </div>
    </div>
  </div>

  <script>
    // Note: This dashboard uses textContent and safe DOM methods where possible.
    // innerHTML is used only with trusted server data for rendering complex HTML structures.
    const API_BASE = window.location.origin;
    let currentSessionId = null;
    let pollInterval = null;

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.textContent;
    }

    async function fetchSessions() {
      try {
        const res = await fetch(API_BASE + '/sessions');
        const data = await res.json();
        if (data.success) {
          renderSessions(data.sessions);
        }
        document.getElementById('statusDot').classList.remove('error');
        document.getElementById('statusText').textContent = 'Connected';
      } catch (e) {
        document.getElementById('statusDot').classList.add('error');
        document.getElementById('statusText').textContent = 'Disconnected';
      }
    }

    function renderSessions(sessions) {
      const container = document.getElementById('sessionsList');
      container.replaceChildren();

      if (sessions.length === 0) {
        const loading = document.createElement('div');
        loading.className = 'loading';
        loading.textContent = 'No active sessions';
        container.appendChild(loading);
        return;
      }

      sessions.forEach(s => {
        const item = document.createElement('div');
        item.className = 'session-item' + (s.id === currentSessionId ? ' active' : '');
        item.onclick = () => selectSession(s.id);

        const customer = document.createElement('div');
        customer.className = 'session-customer';
        customer.textContent = s.customer;

        const meta = document.createElement('div');
        meta.className = 'session-meta';
        meta.textContent = s.messageCount + ' messages ';

        const status = document.createElement('span');
        status.className = 'session-status ' + s.status;
        status.textContent = s.status;
        meta.appendChild(status);

        item.appendChild(customer);
        item.appendChild(meta);
        container.appendChild(item);
      });
    }

    async function selectSession(sessionId) {
      currentSessionId = sessionId;
      document.querySelectorAll('.session-item').forEach(el => el.classList.remove('active'));
      event.target.closest('.session-item').classList.add('active');
      await loadSessionData();
    }

    async function loadSessionData() {
      if (!currentSessionId) return;
      try {
        const traceRes = await fetch(API_BASE + '/session/' + currentSessionId + '/trace?format=json');
        const traceData = await traceRes.json();
        if (traceData.success) {
          renderChat(traceData.trace);
          renderTrace(traceData.trace);
        }
      } catch (e) {
        console.error('Failed to load session:', e);
      }
    }

    function renderChat(trace) {
      const container = document.getElementById('chatMessages');
      container.replaceChildren();

      const messages = trace.timeline.filter(e => e.type === 'message');
      document.getElementById('chatTitle').textContent = currentSessionId.slice(0, 20) + '...';

      const agents = trace.summary.agents || [];
      document.getElementById('chatAgent').textContent = agents.length > 0 ? 'Agent: ' + agents[agents.length - 1] : '';

      messages.forEach(m => {
        const msg = document.createElement('div');
        msg.className = 'message ' + (m.data.role === 'customer' ? 'customer' : 'agent');

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.textContent = m.data.content;

        const meta = document.createElement('div');
        meta.className = 'message-meta';
        meta.textContent = new Date(m.timestamp).toLocaleTimeString();

        msg.appendChild(bubble);
        msg.appendChild(meta);
        container.appendChild(msg);
      });

      container.scrollTop = container.scrollHeight;
    }

    function renderTrace(trace) {
      const stats = document.getElementById('traceStats');
      stats.replaceChildren();
      const s = trace.summary;

      const statData = [
        { value: s.messageCount, label: 'Messages', cls: '' },
        { value: s.successfulToolCalls, label: 'Tool OK', cls: 'success' },
        { value: s.failedToolCalls, label: 'Errors', cls: 'error' },
        { value: (s.duration/1000).toFixed(1) + 's', label: 'Duration', cls: '' }
      ];

      statData.forEach(st => {
        const div = document.createElement('div');
        div.className = 'stat ' + st.cls;
        const val = document.createElement('div');
        val.className = 'stat-value';
        val.textContent = st.value;
        const lbl = document.createElement('div');
        lbl.className = 'stat-label';
        lbl.textContent = st.label;
        div.appendChild(val);
        div.appendChild(lbl);
        stats.appendChild(div);
      });

      const timeline = document.getElementById('traceTimeline');
      timeline.replaceChildren();

      trace.timeline.forEach(e => {
        const evt = document.createElement('div');
        let cls = 'trace-event ' + e.type;
        if (e.type === 'tool_call') {
          cls += e.data.success ? ' success' : ' failure';
        }
        evt.className = cls;

        const typeSpan = document.createElement('span');
        typeSpan.className = 'trace-type';
        typeSpan.textContent = e.type;

        const timeSpan = document.createElement('span');
        timeSpan.className = 'trace-time';
        timeSpan.textContent = ' ' + new Date(e.timestamp).toLocaleTimeString();

        const dataDiv = document.createElement('div');
        dataDiv.className = 'trace-data';

        if (e.type === 'routing') {
          dataDiv.textContent = e.data.from + ' -> ' + e.data.to + ' (' + e.data.reason + ')';
        } else if (e.type === 'tool_call') {
          dataDiv.textContent = e.data.tool + ' ' + (e.data.success ? 'OK' : 'FAILED: ' + (e.data.error || ''));
        } else if (e.type === 'escalation') {
          dataDiv.textContent = 'ESCALATED';
        } else if (e.type === 'message') {
          dataDiv.textContent = e.data.role + ': "' + e.data.content.slice(0, 50) + '..."';
        }

        evt.appendChild(typeSpan);
        evt.appendChild(timeSpan);
        evt.appendChild(dataDiv);
        timeline.appendChild(evt);
      });
    }

    async function sendMessage() {
      if (!currentSessionId) {
        alert('Select a session first');
        return;
      }
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      if (!message) return;
      input.value = '';
      input.disabled = true;
      try {
        await fetch(API_BASE + '/session/' + currentSessionId + '/message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: message })
        });
        await loadSessionData();
      } catch (e) {
        console.error('Failed to send message:', e);
      } finally {
        input.disabled = false;
        input.focus();
      }
    }

    function showNewSessionModal() {
      document.getElementById('newSessionModal').classList.remove('hidden');
    }

    function hideNewSessionModal() {
      document.getElementById('newSessionModal').classList.add('hidden');
    }

    async function createSession() {
      const email = document.getElementById('customerEmail').value;
      const firstName = document.getElementById('firstName').value;
      const lastName = document.getElementById('lastName').value;
      const shopifyId = document.getElementById('shopifyId').value || 'cust_demo';

      if (!email || !firstName) {
        alert('Email and First Name are required');
        return;
      }

      try {
        const res = await fetch(API_BASE + '/session/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            customerEmail: email,
            firstName: firstName,
            lastName: lastName,
            shopifyCustomerId: shopifyId
          })
        });
        const data = await res.json();
        if (data.success) {
          hideNewSessionModal();
          await fetchSessions();
          currentSessionId = data.sessionId;
          await loadSessionData();
        }
      } catch (e) {
        console.error('Failed to create session:', e);
      }
    }

    fetchSessions();
    pollInterval = setInterval(function() {
      fetchSessions();
      if (currentSessionId) loadSessionData();
    }, 3000);
  </script>
</body>
</html>
